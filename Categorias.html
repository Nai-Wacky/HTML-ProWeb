<!DOCTYPE html>
<html>
  <head>
    <meta
      charset="utf-8"
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />

    <link rel="stylesheet" href="StyleC.css" />

    <title>Productos</title>

    <link rel="icon" href="images/Any-job-icon.ico" type="image/x-icon" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
      }

      .navbar {
        background-color: #003f63;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 20px;
      }

      .buttonImageLogo {
        background: none;
        border: none;
        cursor: pointer;
        margin-left: 5px;
      }

      

      .search-box {
        display: flex;
        align-items: center;
        border: 2px solid #ccc;
        border-radius: 10px;
        padding: 5px 10px;
        width: 500px;
        background-color: white;
      }

      .search-box input {
        border: none;
        outline: none;
        flex: 1;
        padding: 5px;
        font-size: 16px;
        background: transparent;
      }

      .search-box input::placeholder {
        font-style: italic;
        color: #aaa;
      }

      .search-box button {
        background: none;
        border: none;
        cursor: pointer;
      }

      .search-box button img {
        width: 20px;
        height: 20px;
      }

      .buttonOpcion {
        background: none;
        border: none;
        cursor: pointer;
        margin-right: 35px;
      }

      .carousel {
        position: relative;
        max-width: auto;
        margin: auto;
        overflow: hidden;
      }

      .slides {
        display: flex;
        transition: transform 0.5s ease-in-out;
      }

      .slide {
        min-width: 100%;
        box-sizing: border-box;
      }

      .slide img {
        width: 100%;
        display: block;
      }

      .familyContainer {
        display: flex;
        padding-left: 80px;
        padding-right: 80px;
      }

      .familyContainer > div {
        width: auto;
        display: inline-block;
        margin: auto;
        border-radius: 10px;
        background-color: #ffffff;
        text-align: center;
      }
    </style>
  </head>

  <body style="background-color: #e3f2fd">
    <div class="navbar">
      <!-- Logo Izquierda -->

      <button
        class="buttonImageLogo"
        onclick="window.location.assign('AnyJobHome.html')"
      >
        <img
          src="images/Any Job Imagotipo chiquito.png"
          width="180"
          height="60"
          title="Any job"
        />
      </button>

      <!-- Buscador -->

      <div style="margin: 0 auto" class="search-box">
        <input id="searchInput" type="text" placeholder="Herramientas..." maxlength="30" />
        <button onclick="buscarProductos()">
          <img
            src="https://cdn-icons-png.flaticon.com/512/622/622669.png"
            alt="Buscar"
          />
        </button>
      </div>

      <!-- Opciones -->

      <button
        class="buttonOpcion"
        onclick="window.location.assign('Perfil.html')"
      >
        <img
          src="images/navbar/Perfil Any Job.png"
          href=""
          width="38"
          height="43"
          title="Perfil"
        />
        <h3 id="bienvenida" style="color: white">Login</h3>
      </button>

      <button
        class="buttonOpcion"
        onclick="window.location.assign('Carrito.html')"
      >
        <img
          src="images/navbar/Carrito de compras.png"
          width="43"
          height="43"
          title="Carrito de compras"
        />
      </button>
    </div>

    <br />
    <br />
    <br />

    <div class="contenedor">
      <div
        class="categorias"
        style="
          background-color: #e3f2fd;
          border: 2px solid lightgray;
          margin-top: 10px;
          margin-left: 10px;
          padding-top: 10px;
          padding-bottom: 10px;
          border-radius: 5px;
        "
      >
        <h3 style="font-weight: bold">Categoria</h3>
        <br />
        <div id="lista-categorias">
          <!-- Las categorías se cargarán dinámicamente aquí -->
        </div>

        <br />

        <h3 style="font-weight: bold">Marca</h3>
        <br />

        <p class="familias">Truper</p>
        <p class="familias">Pretul</p>
        <p class="familias">Makita</p>
        <p class="familias">Husky</p>
        <p class="familias">Cuervo</p>
        <p class="familias">Urrea</p>
      </div>

      <div class="carrusel">
        <div class="carrusel-contenido" id="carrusel"></div>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-section">
        <h2>Información</h2>
        <a href="#">Acerca de nosotros</a>
        <a href="#">Términos y condiciones</a>
        <a href="#">Aviso de privacidad</a>
      </div>

      <div class="footer-section">
        <h2>Atención al cliente</h2>
        <a href="#">Garantías</a>
        <a href="#">Devoluciones</a>
        <a href="#">Facturación</a>
      </div>

      <div class="footer-section">
        <h2>Contáctanos</h2>
        <p>📞 800 00 ANY JOB</p>
        <p>✉️ servicioac@anyjob.com.mx</p>
        <div class="social-icons">
          <a href="#"
            ><img src="images/icons/facebook.svg" alt="Facebook" />Facebook</a
          >
          <a href="#"
            ><img
              src="images/icons/instagram.svg"
              alt="Instagram"
            />Instagram</a
          >
          <a href="#"
            ><img src="images/icons/twitter.svg" alt="Twitter" />Twitter</a
          >
        </div>
      </div>
    </footer>

      <div class="imgFooter">
        <img src="images/Any job isotipo.png" alt="Isotipo" />
      </div>
    </footer>
    <script>
      // Función para normalizar texto (eliminar acentos y convertir a minúsculas)
      function normalizarTexto(texto) {
        return texto.toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");
      }

      // Función para obtener parámetros de la URL
      function obtenerFiltros() {
        const params = new URLSearchParams(window.location.search);
        const filtro = params.get("filtro");
        cargarProductos(filtro);
      }

      async function cargarProductos(filtro = null) {
        const contenedorProductos = document.getElementById("carrusel");
        
        try {
          const response = await fetch("phps/getProductos.php");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          
          console.log("Datos recibidos del servidor:", data);

          contenedorProductos.innerHTML = "";

          if (!Array.isArray(data) || data.length === 0) {
            contenedorProductos.innerHTML = `
              <div style="width: 100%; text-align: center; padding: 20px;">
                <h3>No hay productos disponibles</h3>
              </div>
            `;
            return;
          }

          const marcas = ["Truper", "Pretul", "Makita", "Husky", "Cuervo", "Urrea"];
          const categorias = ["Herramientas", "Eléctricos", "Abrasivos", 
                            "Tornillería y clavos", 
                            "Protección y accesorios", "Adhesivos"];

          let productosFiltrados = data;
          let esMarca = false;
          let esCategoria = false;
          
          // Excluir productos de la categoría Materiales
          productosFiltrados = productosFiltrados.filter(producto => 
            normalizarTexto(producto.Categoria || '') !== 'materiales'
          );
          
          // Aplicar filtro de marca/categoría
          if (filtro) {
            const filtroNormalizado = normalizarTexto(filtro);
            esMarca = marcas.some(marca => normalizarTexto(marca) === filtroNormalizado);
            esCategoria = categorias.some(categoria => normalizarTexto(categoria) === filtroNormalizado);

            productosFiltrados = productosFiltrados.filter(producto => {
              if (esMarca) {
                return normalizarTexto(producto.Marca || '') === filtroNormalizado;
              } else if (esCategoria) {
                return normalizarTexto(producto.Categoria || '') === filtroNormalizado;
              } else {
                return producto.nombre && normalizarTexto(producto.nombre).includes(filtroNormalizado);
              }
            });
          }

          if (productosFiltrados.length === 0) {
            let mensaje = 'No hay productos disponibles';
            if (filtro) {
              mensaje = `No se encontraron productos ${esMarca ? 'de la marca' : 'en la categoría'} "${filtro}"`;
            }
            
            contenedorProductos.innerHTML = `
              <div style="width: 100%; text-align: center; padding: 20px;">
                <h3>${mensaje}</h3>
              </div>
            `;
            return;
          }

          // Mostrar notificación con el número de resultados
          let mensajeResultados = `Se encontraron ${productosFiltrados.length} productos`;
          if (filtro) {
            mensajeResultados += ` ${esMarca ? 'de la marca' : 'en la categoría'} "${filtro}"`;
          }
          mostrarNotificacion(mensajeResultados, 'success');

          // Recorrer el arreglo de productos y crear los elementos para cada producto
          productosFiltrados.forEach((producto) => {
            const productoDiv = document.createElement("div");
            productoDiv.classList.add("producto");

            // Crear el contenedor del carrusel
            const carruselContainer = document.createElement("div");
            carruselContainer.classList.add("producto-carrusel");
            
            // Crear los botones de navegación
            const btnPrev = document.createElement("button");
            btnPrev.classList.add("carrusel-btn", "prev-btn");
            btnPrev.innerHTML = "&#10094;";
            
            const btnNext = document.createElement("button");
            btnNext.classList.add("carrusel-btn", "next-btn");
            btnNext.innerHTML = "&#10095;";

            // Crear el contenedor de imágenes
            const imgContainer = document.createElement("div");
            imgContainer.classList.add("producto-imagenes");
            
            // Crear la imagen principal
            const imgPrincipal = document.createElement("img");
            imgPrincipal.src = producto.imagenes[0] || 'images/default-product.jpg';
            imgPrincipal.alt = producto.nombre || 'Producto';
            imgPrincipal.dataset.imagenIndex = "0";
            imgPrincipal.dataset.imagenes = JSON.stringify(producto.imagenes);
            
            // Agregar los elementos al carrusel
            imgContainer.appendChild(imgPrincipal);
            carruselContainer.appendChild(btnPrev);
            carruselContainer.appendChild(imgContainer);
            carruselContainer.appendChild(btnNext);

            // Agregar eventos a los botones
            btnPrev.onclick = (e) => {
              e.stopPropagation();
              cambiarImagen(imgPrincipal, -1);
            };
            
            btnNext.onclick = (e) => {
              e.stopPropagation();
              cambiarImagen(imgPrincipal, 1);
            };

            // Crear enlace para el nombre del producto
            const nombreLink = document.createElement("a");
            nombreLink.href = `ProductoMostrador.html?id=${producto.id_producto}`;
            nombreLink.style.textDecoration = "none";
            nombreLink.style.color = "inherit";
            nombreLink.style.cursor = "pointer";

            const nombre = document.createElement("h3");
            nombre.textContent = producto.nombre || 'Producto sin nombre';
            nombre.style.transition = "color 0.3s ease";
            
            nombreLink.appendChild(nombre);

            const precio = document.createElement("p");
            precio.textContent = producto.precio ? `$${producto.precio}` : 'Precio no disponible';

            const boton = document.createElement("button");
            boton.classList.add("boton-agregar");
            boton.textContent = "Añadir al carrito";
            boton.onclick = () => agregarAlCarrito(producto.id_producto);

            // También hacer que la imagen sea clickeable
            imgContainer.style.cursor = "pointer";
            imgContainer.onclick = () => {
              window.location.href = `ProductoMostrador.html?id=${producto.id_producto}`;
            };

            // Agregar los elementos al contenedor del producto
            productoDiv.appendChild(carruselContainer);
            productoDiv.appendChild(nombreLink);
            productoDiv.appendChild(precio);
            productoDiv.appendChild(boton);

            // Agregar el producto al contenedor
            contenedorProductos.appendChild(productoDiv);
          });

        } catch (error) {
          console.error("Error al cargar los productos:", error);
          contenedorProductos.innerHTML = `
            <div style="width: 100%; text-align: center; padding: 20px;">
              <h3>Error al cargar los productos: ${error.message}</h3>
            </div>
          `;
        }
      }

      // Función para agregar al carrito
      async function agregarAlCarrito(idProducto) {
        if (!idProducto) {
          mostrarNotificacion('Error: ID de producto no válido', 'error');
          return;
        }

        try {
          const formData = new FormData();
          formData.append('idProducto', idProducto);

          const response = await fetch('phps/agregarAlCarrito.php', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();
          console.log('Respuesta del servidor:', data);

          if (data.success) {
            mostrarNotificacion(data.success, 'success');
          } else if (data.error) {
            if (data.error.includes('iniciar sesión')) {
              mostrarNotificacion('Debes iniciar sesión para agregar productos al carrito', 'error');
              setTimeout(() => {
                window.location.href = 'Login.html';
              }, 2000);
            } else {
              mostrarNotificacion(data.error, 'error');
            }
          }
        } catch (error) {
          console.error('Error al agregar al carrito:', error);
          mostrarNotificacion('Error al agregar al carrito', 'error');
        }
      }

      // Función para mostrar notificaciones
      function mostrarNotificacion(mensaje, tipo) {
        const notificacion = document.createElement('div');
        notificacion.className = `notificacion ${tipo}`;
        notificacion.textContent = mensaje;
        
        // Estilos para la notificación
        notificacion.style.position = 'fixed';
        notificacion.style.top = '20px';
        notificacion.style.right = '20px';
        notificacion.style.padding = '15px 25px';
        notificacion.style.borderRadius = '5px';
        notificacion.style.zIndex = '1000';
        
        if (tipo === 'success') {
          notificacion.style.backgroundColor = '#4CAF50';
          notificacion.style.color = 'white';
        } else {
          notificacion.style.backgroundColor = '#f44336';
          notificacion.style.color = 'white';
        }

        document.body.appendChild(notificacion);

        // Eliminar la notificación después de 3 segundos
        setTimeout(() => {
          notificacion.style.opacity = '0';
          notificacion.style.transition = 'opacity 0.5s ease';
          setTimeout(() => {
            document.body.removeChild(notificacion);
          }, 500);
        }, 3000);
      }

      // Función para verificar la sesión
      async function verificarSesion() {
        try {
          const response = await fetch('phps/checkSession.php');
          const data = await response.json();
          
          const bienvenidaElement = document.getElementById('bienvenida');
          
          if (data.loggedin) {
            bienvenidaElement.textContent = `¡Hola, ${data.nombre}!`;
          } else {
            bienvenidaElement.textContent = 'Login';
          }
        } catch (error) {
          console.error('Error al verificar la sesión:', error);
        }
      }

      // Función para cargar las categorías en el panel lateral
      function cargarCategorias() {
        const categorias = ["Herramientas", "Eléctricos", "Abrasivos", 
                          "Tornillería y clavos", 
                          "Protección y accesorios", "Adhesivos"];
        
        const listaCategorias = document.getElementById('lista-categorias');
        listaCategorias.innerHTML = categorias.map(categoria => 
          `<p class="familias">${categoria}</p>`
        ).join('');

        // Agregar eventos de clic a las categorías y marcas
        document.querySelectorAll('.familias').forEach(elemento => {
          elemento.addEventListener('click', () => {
            const filtro = elemento.textContent.trim();
            window.location.href = `Categorias.html?filtro=${encodeURIComponent(filtro)}`;
          });
          elemento.style.cursor = 'pointer';
          elemento.style.transition = 'color 0.3s ease';
          
          // Agregar efectos hover
          elemento.addEventListener('mouseenter', () => {
            elemento.style.color = '#003f63';
          });
          elemento.addEventListener('mouseleave', () => {
            elemento.style.color = 'inherit';
          });
        });
      }

      // Inicializar la página
      window.addEventListener('DOMContentLoaded', () => {
        verificarSesion();
        obtenerFiltros();
        cargarCategorias();
      });

      //----------------------------------------------LOCALSTORAGE----------------------------------------------

      const nombre = localStorage.getItem("nombre");

      window.addEventListener("DOMContentLoaded", () => {
        const nombreGuardado = localStorage.getItem("usuarioNombre");
        if (nombreGuardado) {
          document.getElementById("bienvenida").textContent = nombreGuardado;
        }
      });

      // Función para cambiar la imagen en el carrusel
      function cambiarImagen(imgElement, direccion) {
        const imagenes = JSON.parse(imgElement.dataset.imagenes);
        let currentIndex = parseInt(imgElement.dataset.imagenIndex);
        
        // Calcular el nuevo índice
        currentIndex = (currentIndex + direccion + imagenes.length) % imagenes.length;
        
        // Actualizar la imagen
        imgElement.src = imagenes[currentIndex];
        imgElement.dataset.imagenIndex = currentIndex;
        
        // Efecto de transición
        imgElement.style.opacity = '0';
        setTimeout(() => {
          imgElement.style.opacity = '1';
        }, 50);
      }

      // Función para buscar productos
      async function buscarProductos() {
        const searchInput = document.getElementById('searchInput');
        const query = searchInput.value.trim();
        
        if (!query) {
          mostrarNotificacion('Por favor ingresa un término de búsqueda', 'error');
          return;
        }

        try {
          const response = await fetch(`phps/buscarProductos.php?query=${encodeURIComponent(query)}`);
          const data = await response.json();

          if (!data.success) {
            mostrarNotificacion(data.error || 'Error al buscar productos', 'error');
            return;
          }

          const contenedor = document.getElementById('carrusel');
          
          if (data.productos.length === 0) {
            contenedor.innerHTML = `
              <div style="width: 100%; text-align: center; padding: 20px;">
                <h3>No se encontraron productos para "${query}"</h3>
              </div>
            `;
            return;
          }

          contenedor.innerHTML = "";

          // Recorrer el arreglo de productos y crear los elementos para cada producto
          data.productos.forEach((producto) => {
            const productoDiv = document.createElement("div");
            productoDiv.classList.add("producto");

            // Crear el contenedor del carrusel
            const carruselContainer = document.createElement("div");
            carruselContainer.classList.add("producto-carrusel");
            
            // Crear los botones de navegación
            const btnPrev = document.createElement("button");
            btnPrev.classList.add("carrusel-btn", "prev-btn");
            btnPrev.innerHTML = "&#10094;";
            
            const btnNext = document.createElement("button");
            btnNext.classList.add("carrusel-btn", "next-btn");
            btnNext.innerHTML = "&#10095;";

            // Crear el contenedor de imágenes
            const imgContainer = document.createElement("div");
            imgContainer.classList.add("producto-imagenes");
            
            // Crear la imagen principal
            const imgPrincipal = document.createElement("img");
            imgPrincipal.src = producto.imagenes[0] || 'images/default-product.jpg';
            imgPrincipal.alt = producto.nombre || 'Producto';
            imgPrincipal.dataset.imagenIndex = "0";
            imgPrincipal.dataset.imagenes = JSON.stringify(producto.imagenes);
            
            // Agregar los elementos al carrusel
            imgContainer.appendChild(imgPrincipal);
            carruselContainer.appendChild(btnPrev);
            carruselContainer.appendChild(imgContainer);
            carruselContainer.appendChild(btnNext);

            // Agregar eventos a los botones
            btnPrev.onclick = (e) => {
              e.stopPropagation();
              cambiarImagen(imgPrincipal, -1);
            };
            
            btnNext.onclick = (e) => {
              e.stopPropagation();
              cambiarImagen(imgPrincipal, 1);
            };

            // Crear enlace para el nombre del producto
            const nombreLink = document.createElement("a");
            nombreLink.href = `ProductoMostrador.html?id=${producto.id_producto}`;
            nombreLink.style.textDecoration = "none";
            nombreLink.style.color = "inherit";
            nombreLink.style.cursor = "pointer";

            const nombre = document.createElement("h3");
            nombre.textContent = producto.nombre || 'Producto sin nombre';
            nombre.style.transition = "color 0.3s ease";
            
            nombreLink.appendChild(nombre);

            const precio = document.createElement("p");
            precio.textContent = producto.precio ? `$${producto.precio}` : 'Precio no disponible';

            const boton = document.createElement("button");
            boton.classList.add("boton-agregar");
            boton.textContent = "Añadir al carrito";
            boton.onclick = () => agregarAlCarrito(producto.id_producto);

            // También hacer que la imagen sea clickeable
            imgContainer.style.cursor = "pointer";
            imgContainer.onclick = () => {
              window.location.href = `ProductoMostrador.html?id=${producto.id_producto}`;
            };

            // Agregar los elementos al contenedor del producto
            productoDiv.appendChild(carruselContainer);
            productoDiv.appendChild(nombreLink);
            productoDiv.appendChild(precio);
            productoDiv.appendChild(boton);

            // Agregar el producto al contenedor
            contenedor.appendChild(productoDiv);
          });

          // Mostrar notificación de éxito con el número de resultados
          mostrarNotificacion(`Se encontraron ${data.total} productos`, 'success');

        } catch (error) {
          console.error('Error:', error);
          mostrarNotificacion('Error al realizar la búsqueda', 'error');
        }
      }

      // Agregar evento para buscar al presionar Enter
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          buscarProductos();
        }
      });
    </script>
  </body>
</html>
